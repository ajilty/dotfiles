#######################################################
# ENVIROMENT VARIABLES
#######################################################

# Set XDG Base Directory Specification
export XDG_CONFIG_HOME="$HOME/.config"
export XDG_CACHE_HOME="$HOME/.cache"
export XDG_DATA_HOME="$HOME/.local/share"
export XDG_STATE_HOME="$HOME/.local/state"
export PATH=$PATH:~/.local/bin

# Local binaries
export PATH=$PATH:~/bin

# Homebrew (macOS) / Linuxbrew (Linux)
if [ -d "/opt/homebrew/bin" ]; then
    # macOS Homebrew
    export HOMEBREW_PREFIX="/opt/homebrew"
elif [ -d "/home/linuxbrew/.linuxbrew/bin" ]; then
    # Linuxbrew
    export HOMEBREW_PREFIX="/home/linuxbrew/.linuxbrew"
fi

if [ -n "$HOMEBREW_PREFIX" ]; then
    export HOMEBREW_CELLAR="$HOMEBREW_PREFIX/Cellar"
    export HOMEBREW_REPOSITORY="$HOMEBREW_PREFIX"
    export PATH="$HOMEBREW_PREFIX/bin:$HOMEBREW_PREFIX/sbin${PATH+:$PATH}"
    export MANPATH="$HOMEBREW_PREFIX/share/man${MANPATH+:$MANPATH}:"
    export INFOPATH="$HOMEBREW_PREFIX/share/info:${INFOPATH:-}"
fi

# Temp Directory
# Fix TMPDIR if it's set to root's or wrong user's temp directory
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS specific
    if [[ "$TMPDIR" == "/var/folders/zz/"* ]] || [[ ! -w "$TMPDIR" ]]; then
        export TMPDIR=$(getconf DARWIN_USER_TEMP_DIR)
    fi
else
    # Linux - use /tmp if TMPDIR is not set or not writable
    if [[ -z "$TMPDIR" ]] || [[ ! -w "$TMPDIR" ]]; then
        export TMPDIR="/tmp"
    fi
fi

if [ -d "$TMPDIR" ]; then
    export TMPPREFIX="$TMPDIR"
    export TMUX_TMPDIR="$TMPDIR"
    export HOMEBREW_TEMP="$TMPDIR"
    
    # macOS specific: check if the permissions of /private/tmp have user set to current user
    if [[ "$OSTYPE" == "darwin"* ]] && [ -d "/private/tmp" ]; then
        if [ "$(stat -f %Su /private/tmp)" != "$(whoami)" ]; then
            echo "Setting /private/tmp permissions to current user"
            sudo chown -R $(whoami) /private/tmp
            # sudo chown $(whoami):admin /private/tmp/
        fi
    fi
fi

# Golang
export GOPATH="$XDG_DATA_HOME/go"
export PATH="$PATH:$GOPATH/bin"

# Rancher Desktop (if installed)
if [ -d "$HOME/.rd/bin" ]; then
    export RD_BIN="$HOME/.rd/bin"
    export PATH="$RD_BIN:$PATH"
    if [ -f "$RD_BIN/rancher-desktop" ]; then
        export RD_BIN="$RD_BIN/rancher-desktop"
    fi
fi

# Python PIP
export PIP_DOWNLOAD_CACHE=$XDG_CACHE_HOME/pip
export PIP_LOG_FILE=$XDG_CACHE_HOME/pip/pip.log
export PIP_BUILD=$XDG_CACHE_HOME/pip/build

# Python Pyenv
if command -v pyenv 1>/dev/null 2>&1; then
    export PYENV_ROOT="$XDG_DATA_HOME/pyenv"
    export PATH="$PYENV_ROOT/bin:$PATH"
    eval "$(pyenv init -)"
fi

# AWS
export AWS_PAGER=""
if [ -f ~/.local/config/aws/config ]; then
    export AWS_CONFIG_FILE=~/.local/config/aws/config
else
    export AWS_CONFIG_FILE=~/.config/aws/config
fi

# DotNET
if command -v dotnet >/dev/null 2>&1; then
    export DOTNET_ROOT=$(dirname $(which dotnet))
    export DOTNET_SKIP_FIRST_TIME_EXPERIENCE=true
    export DOTNET_CLI_TELEMETRY_OPTOUT=false
fi

# VSCode
export PATH=$PATH:/Applications/Visual\ Studio\ Code.app/Contents/Resources/app/bin
export PATH=$PATH:/Applications/Visual\ Studio\ Code\ -\ Insiders.app/Contents/Resources/app/bin
if command -v code 1>/dev/null 2>&1; then
    export EDITOR="code --wait"
fi

# MySQL
if [[ -n "$HOMEBREW_PREFIX" && -d "$HOMEBREW_PREFIX/opt/mysql-client/bin" ]]; then
    export PATH="$HOMEBREW_PREFIX/opt/mysql-client/bin:$PATH"
    
    # For compilers to find mysql-client you may need to set:
    export LDFLAGS="-L$HOMEBREW_PREFIX/opt/mysql-client/lib"   
    export CPPFLAGS="-I$HOMEBREW_PREFIX/opt/mysql-client/include"

    #For pkg-config to find mysql-client you may need to set:
    export PKG_CONFIG_PATH="$HOMEBREW_PREFIX/opt/mysql-client/lib/pkgconfig"
fi

# -----------------------------------------------
# Local environment variables. This is last to override any previous settings
if [ -e ~/.local/config/shell/environment ]; then
    source ~/.local/config/shell/environment
fi